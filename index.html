<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TGF - The Green Forest</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0fdf4; /* A very light, calming green */
        }
        .bg-gradient-forest {
            background-image: linear-gradient(to right, #22c55e, #16a34a, #15803d);
        }
        .chat-bubble-user {
            background-color: #166534; /* Darker green for user */
            color: #ffffff;
        }
        .chat-bubble-ai {
            background-color: #ffffff;
            color: #14532d;
            border: 1px solid #e5e7eb;
        }
        .glowing-pulse {
            animation: pulse-glow 2s infinite ease-out;
        }
        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 12px rgba(34, 197, 94, 0.4); }
            50% { box-shadow: 0 0 24px rgba(34, 197, 94, 0.8); }
        }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .option-btn.selected {
            background-color: #16a34a !important;
            color: white !important;
            border-color: #15803d !important;
            transform: scale(1.05);
            box-shadow: 0 4px 14px 0 rgba(22, 163, 74, 0.39);
        }
        .recording { color: #ef4444; animation: pulse-red 1.5s infinite; }
        @keyframes pulse-red { 0%, 100% { opacity: 1; transform: scale(1.1); } 50% { opacity: 0.7; transform: scale(1); } }
        
        /* Soothing background animation */
        #animation-container {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            z-index: 0;
            overflow: hidden;
            pointer-events: none;
            background: linear-gradient(to bottom, #dcfce7, #f0fdf4);
        }
        .sun {
            position: absolute;
            bottom: 5%;
            left: 50%;
            width: 300px;
            height: 300px;
            background: radial-gradient(circle, rgba(253,224,71,0.5) 0%, rgba(253,224,71,0) 70%);
            border-radius: 50%;
            transform: translateX(-50%);
            animation: sunrise 10s ease-in-out infinite alternate;
        }
        @keyframes sunrise {
            from { transform: translateX(-50%) translateY(100px); opacity: 0.8;}
            to { transform: translateX(-50%) translateY(0); opacity: 1;}
        }
        .tree {
            position: absolute;
            bottom: -50px;
            width: 400px;
            height: 400px;
            background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><path d="M50 100 C 40 80, 20 70, 25 50 C 30 30, 40 35, 50 20 C 60 35, 70 30, 75 50 C 80 70, 60 80, 50 100 Z" fill="%2314532d" opacity="0.1"/></svg>');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: bottom center;
        }
    </style>
</head>
<body class="text-gray-800 antialiased">
    
    <div id="animation-container">
        <div class="sun"></div>
        <div class="tree" style="left: -10%; transform: scale(0.8);"></div>
        <div class="tree" style="right: -15%; transform: scale(0.9);"></div>
        <div class="tree" style="left: 20%; transform: scale(0.6);"></div>
    </div>

    <div id="app" class="h-screen w-screen flex items-center justify-center p-4 relative z-10">
        
        <!-- Onboarding Screen -->
        <div id="onboarding-screen" class="w-full max-w-lg p-6 md:p-8 bg-white/80 backdrop-blur-sm rounded-2xl shadow-2xl text-center fade-in">
            <h1 class="text-3xl md:text-4xl font-bold text-green-800 mb-2">Welcome to The Green Forest</h1>
            <p class="text-gray-600 mb-8">Your personal sanctuary to talk, reflect, and grow.</p>
            
            <div class="space-y-6 text-left">
                <div>
                    <label for="companion-name" class="block text-sm font-medium text-gray-700">First, what should I call your companion?</label>
                    <input type="text" id="companion-name" class="mt-1 block w-full px-4 py-2 bg-gray-50 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="e.g., Kai, Aura, Echo">
                </div>

                <div>
                    <p class="block text-sm font-medium text-gray-700 mb-2">And who is this companion to you?</p>
                    <div class="flex flex-wrap gap-2">
                         <button onclick="selectOption('role', 'Friend', this)" class="option-btn role-option px-3 py-1.5 text-sm border rounded-full hover:bg-green-100 transition">Friend</button>
                         <button onclick="selectOption('role', 'Mentor', this)" class="option-btn role-option px-3 py-1.5 text-sm border rounded-full hover:bg-green-100 transition">Mentor</button>
                         <button onclick="selectOption('role', 'Parent', this)" class="option-btn role-option px-3 py-1.5 text-sm border rounded-full hover:bg-green-100 transition">Parent</button>
                         <button onclick="selectOption('role', 'Sibling', this)" class="option-btn role-option px-3 py-1.5 text-sm border rounded-full hover:bg-green-100 transition">Sibling</button>
                         <button onclick="selectOption('role', 'Partner', this)" class="option-btn role-option px-3 py-1.5 text-sm border rounded-full hover:bg-green-100 transition">Partner</button>
                    </div>
                </div>

                 <div>
                    <p class="block text-sm font-medium text-gray-700 mb-2">Finally, what's their vibe? (You can pick a few)</p>
                    <div class="flex flex-wrap gap-2">
                         <button onclick="selectOption('tone', 'Empathetic', this)" class="option-btn tone-option px-3 py-1.5 text-sm border rounded-full hover:bg-green-100 transition">Empathetic</button>
                         <button onclick="selectOption('tone', 'Funny', this)" class="option-btn tone-option px-3 py-1.5 text-sm border rounded-full hover:bg-green-100 transition">Funny</button>
                         <button onclick="selectOption('tone', 'Calm & Wise', this)" class="option-btn tone-option px-3 py-1.5 text-sm border rounded-full hover:bg-green-100 transition">Calm & Wise</button>
                         <button onclick="selectOption('tone', 'Playful', this)" class="option-btn tone-option px-3 py-1.5 text-sm border rounded-full hover:bg-green-100 transition">Playful</button>
                         <button onclick="selectOption('tone', 'Grounded', this)" class="option-btn tone-option px-3 py-1.5 text-sm border rounded-full hover:bg-green-100 transition">Grounded</button>
                         <button onclick="selectOption('tone', 'Straightforward', this)" class="option-btn tone-option px-3 py-1.5 text-sm border rounded-full hover:bg-green-100 transition">Straightforward</button>
                    </div>
                </div>
            </div>
            
            <button id="start-chatting-btn" onclick="startChat()" class="mt-8 w-full bg-gradient-forest text-white font-bold py-3 px-4 rounded-lg shadow-lg hover:opacity-90 transition-transform transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed glowing-pulse" disabled>
                Create Companion & Enter
            </button>
        </div>

        <!-- Main App Screen -->
        <div id="main-screen" class="hidden h-full w-full max-w-5xl flex flex-col md:flex-row rounded-2xl shadow-2xl overflow-hidden bg-white/70 backdrop-blur-md">
            <!-- Sidebar -->
            <div class="w-full md:w-24 bg-green-800 flex md:flex-col justify-around md:justify-start items-center p-2 md:py-6 md:p-0 space-x-4 md:space-x-0 md:space-y-6">
                 <button onclick="goHome()" class="sidebar-btn p-3 rounded-xl hover:bg-green-700 transition-colors" title="Start Over">
                    <svg class="h-6 w-6 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 15L3 9m0 0l6-6M3 9h12a6 6 0 010 12h-3" /></svg>
                </button>
            </div>
            <!-- Chat View -->
            <div id="chat-view" class="flex-1 flex flex-col bg-transparent">
                <header class="bg-white/80 backdrop-blur-sm border-b border-gray-200 p-4 flex items-center justify-between shadow-sm">
                    <div>
                        <h2 id="chat-header" class="text-lg font-semibold text-gray-800">Chat with Companion</h2>
                        <p id="chat-subheader" class="text-sm text-gray-500">A safe space to talk.</p>
                    </div>
                </header>
                <div id="chat-messages" class="flex-1 p-4 md:p-6 overflow-y-auto space-y-4 flex flex-col bg-transparent" style="background-size: cover; background-position: center;"></div>
                <div class="p-4 bg-white/80 backdrop-blur-sm border-t border-gray-200">
                    <div class="flex items-center space-x-2 md:space-x-3">
                        <input type="text" id="message-input" class="flex-1 block w-full px-5 py-3 bg-gray-100 border-transparent rounded-full focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="Type or record a message..." onkeypress="handleKeyPress(event)">
                        <button id="mic-button" onclick="toggleRecording()" class="p-3 rounded-full hover:bg-gray-100 text-gray-500 hover:text-green-600 transition-colors" title="Send Voice Note">
                            <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 18.75a6 6 0 006-6v-1.5a6 6 0 00-12 0v1.5a6 6 0 006 6zM12 12.75V15m0 0V12.75m0 2.25a.75.75 0 01-.75-.75V12a.75.75 0 011.5 0v2.25a.75.75 0 01-.75.75z" /></svg>
                        </button>
                        <button id="send-button" onclick="sendMessage()" class="bg-gradient-forest text-white p-3 rounded-full hover:opacity-90 transition-transform transform hover:scale-105 shadow-lg">
                             <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 12L3.269 3.126A59.768 59.768 0 0121.485 12 59.77 59.77 0 013.27 20.876L5.999 12zm0 0h7.5" /></svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script>
        // --- State and Speech Recognition Setup ---
        let state = {
            companion: { name: '', role: [], tone: [] },
            chatHistory: [],
            isRecording: false
        };
        const apiKey = ""; // This is handled by the execution environment.
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition;

        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = false;

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                document.getElementById('message-input').value = transcript;
                stopRecordingAnimation();
                sendMessage(); // Automatically send after transcription
            };

            recognition.onerror = (event) => {
                console.error("Speech recognition error:", event.error);
                stopRecordingAnimation();
            };
        } else {
            console.warn("Speech Recognition not supported in this browser.");
            document.addEventListener('DOMContentLoaded', () => {
                const micButton = document.getElementById('mic-button');
                if(micButton) micButton.style.display = 'none';
            });
        }
        
        // --- Onboarding Logic ---
        function selectOption(type, value, element) {
            // Simplified logic for single-select 'role'
            if (type === 'role') {
                document.querySelectorAll('.role-option').forEach(btn => btn.classList.remove('selected'));
                state.companion.role = [value];
                element.classList.add('selected');
            } else { // Multi-select for 'tone'
                const selectedValues = state.companion[type];
                if (selectedValues.includes(value)) {
                    state.companion[type] = selectedValues.filter(v => v !== value);
                    element.classList.remove('selected');
                } else {
                    state.companion[type].push(value);
                    element.classList.add('selected');
                }
            }
            validateOnboarding();
        }


        function validateOnboarding() {
            const nameInput = document.getElementById('companion-name').value;
            const startBtn = document.getElementById('start-chatting-btn');
            startBtn.disabled = !(nameInput && state.companion.role.length > 0 && state.companion.tone.length > 0);
        }
        
        document.getElementById('companion-name').addEventListener('input', validateOnboarding);

        function startChat() {
            state.companion.name = document.getElementById('companion-name').value.trim();
            if (!state.companion.name || state.companion.role.length === 0 || state.companion.tone.length === 0) return;

            const roles = state.companion.role.join(', ');
            const tones = state.companion.tone.join(', ');

            const systemPrompt = `You are an AI companion named ${state.companion.name}. Your personality is a mix of these traits: ${tones}. You are acting as the user's ${roles}. Your primary goal is to be a supportive, comforting, and empathetic presence. You must maintain an informal, caring, and genuine tone. Never reveal you are an AI. Remember past details to build a strong connection.`;
            
            state.chatHistory.push({ role: 'system', parts: [{ text: systemPrompt }] });
            
            const greeting = `Hey there! I'm ${state.companion.name}. It's great to meet you. What's on your mind today?`;
            addMessage('ai', greeting);

            document.getElementById('chat-header').textContent = `Chat with ${state.companion.name}`;
            document.getElementById('chat-subheader').textContent = `Your ${tones} ${roles}`;
            document.getElementById('onboarding-screen').classList.add('hidden');
            document.getElementById('main-screen').classList.remove('hidden');
            document.getElementById('main-screen').classList.add('fade-in');
        }
        
        // --- App Navigation Logic ---
        function goHome() {
            window.location.reload(); 
        }

        // --- Chat Logic ---
        function addMessage(sender, text) {
            const messagesContainer = document.getElementById('chat-messages');
            const messageWrapper = document.createElement('div');
            messageWrapper.className = `w-full flex ${sender === 'user' ? 'justify-end' : 'justify-start'}`;
            const bubble = document.createElement('div');
            bubble.className = `max-w-xs md:max-w-md p-3 rounded-2xl shadow-md fade-in flex items-center gap-3 ${ sender === 'user' ? 'chat-bubble-user' : 'chat-bubble-ai' }`;
            
            const sanitizedText = text.replace(/</g, "&lt;").replace(/>/g, "&gt;");
            bubble.innerHTML = `<p>${sanitizedText}</p>`;
            
            if (sender === 'ai') {
                bubble.innerHTML += `<button onclick="speakText(this, '${text.replace(/'/g, "\\'")}')" class="flex-shrink-0 text-green-700 hover:text-green-900"><svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.114 5.636a9 9 0 010 12.728M16.463 8.288a5.25 5.25 0 010 7.424M6.75 8.25l4.72-4.72a.75.75 0 011.28.53v15.88a.75.75 0 01-1.28.53l-4.72-4.72H4.51c-.88 0-1.704-.507-1.938-1.354A9.01 9.01 0 012.25 12c0-.83.112-1.633.322-2.396C2.806 8.756 3.63 8.25 4.51 8.25H6.75z" /></svg></button>`;
            }
            messageWrapper.appendChild(bubble);
            messagesContainer.appendChild(messageWrapper);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;

            const historyRole = sender === 'user' ? 'user' : 'model';
            state.chatHistory.push({ role: historyRole, parts: [{ text }] });
        }
        
        async function sendMessage() {
            const input = document.getElementById('message-input');
            const messageText = input.value.trim();
            if (!messageText) return;

            addMessage('user', messageText);
            input.value = '';
            setLoading(true);

            try {
                const payload = { contents: state.chatHistory.slice(1) }; // Exclude system prompt from direct history
                const systemInstruction = state.chatHistory[0];
                if (systemInstruction) {
                    payload.systemInstruction = systemInstruction;
                }
                
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error(`API error: ${response.statusText}`);
                const result = await response.json();
                const aiResponse = result.candidates?.[0]?.content?.parts?.[0]?.text;
                addMessage('ai', aiResponse || "Sorry, I'm having trouble responding. Please try again.");
            } catch (error) {
                console.error("Error calling Gemini API:", error);
                addMessage('ai', "I'm having a little trouble connecting right now. Let's try again in a bit.");
            } finally {
                setLoading(false);
            }
        }

        function setLoading(isLoading) {
             const input = document.getElementById('message-input');
             const sendButton = document.getElementById('send-button');
             const micButton = document.getElementById('mic-button');
            
             input.disabled = isLoading;
             sendButton.disabled = isLoading;
             if(micButton) micButton.disabled = isLoading;

             if (isLoading) {
                 const typingIndicator = document.createElement('div');
                 typingIndicator.id = 'typing-indicator';
                 typingIndicator.className = 'w-full flex justify-start';
                 typingIndicator.innerHTML = `<div class="chat-bubble-ai self-start p-3 rounded-2xl shadow-md fade-in flex items-center space-x-2"><span class="block w-2 h-2 bg-green-300 rounded-full animate-bounce" style="animation-delay:0s"></span><span class="block w-2 h-2 bg-green-300 rounded-full animate-bounce" style="animation-delay:0.2s"></span><span class="block w-2 h-2 bg-green-300 rounded-full animate-bounce" style="animation-delay:0.4s"></span></div>`;
                 document.getElementById('chat-messages').appendChild(typingIndicator);
                 document.getElementById('chat-messages').scrollTop = document.getElementById('chat-messages').scrollHeight;
             } else {
                 document.getElementById('typing-indicator')?.remove();
                 input.focus();
             }
        }
        
        function handleKeyPress(event) { if (event.key === 'Enter') sendMessage(); }
        
        // --- Audio & Animation Features Logic ---
        function speakText(button, text) {
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(text);
                window.speechSynthesis.cancel();
                window.speechSynthesis.speak(utterance);
            } else {
                alert("Sorry, your browser doesn't support text-to-speech.");
            }
        }

        function toggleRecording() {
            if (!recognition) {
                alert("Your browser doesn't support voice input.");
                return;
            }
            if (state.isRecording) {
                recognition.stop();
                stopRecordingAnimation();
            } else {
                recognition.start();
                document.getElementById('mic-button').classList.add('recording');
                state.isRecording = true;
            }
        }

        function stopRecordingAnimation() {
            document.getElementById('mic-button').classList.remove('recording');
            state.isRecording = false;
        }

    </script>
</body>
</html>
